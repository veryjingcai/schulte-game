<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/w3.css">
    <link rel="stylesheet" href="css/schulte.css">
    <script src="js/vue.min.js"></script>
    <title>ËàíÂ∞îÁâπÊñπÊ†º (Schulte Grid)</title>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" class="app-container"
         tabindex="-1"
         @mousemove="appendMouseMove($event)"
         @keyup.esc="dialogShowed ? hideDialog() : execDialog('settings')"
         v-focus v-cloak>

        <!-- Header / Controls -->
        <header class="app-header">
            <div class="header-title">ËàíÂ∞îÁâπÊñπÊ†º</div>
            <div class="header-timer">{{ timerDisplay }}</div>
            <div class="header-controls">
                <button class="btn btn-icon" @click="execDialog('stats')" title="ÁªüËÆ°">
                    üìä
                </button>
                <button class="btn btn-primary" @click="execDialog('settings')">
                    ËÆæÁΩÆ
                </button>
            </div>
        </header>

        <!-- Main Game Area -->
        <main class="main-content">
            <div class="grid-wrapper" ref="gridContainer" :style="{ '--grid-size': gridSize }">
                
                <div v-for="r in gridRange" class="row">
                    <div v-for="c in gridRange" class="cell"
                         @mouseover="hoveredCell = r*gridSize + c"
                         @mouseleave="hoveredCell = -1"
                         @click="setClickedCell(r*gridSize + c, $event)"
                         :class="{'normal-cell' : !showHover && !showClickAnimation,
                                  'hovered-cell': showHover && (hoveredCell == r*gridSize + c),
                                  'correct-cell': showClickAnimation && (clickedCell == r*gridSize + c) && clickedCell == correctIndex,
                                  'wrong-cell'  : showClickAnimation && (clickedCell == r*gridSize + c) && clickedCell != correctIndex,
                                  'traced-cell' : showTrace && tracedCell(r*gridSize + c)
                                  }">
                        <span class="cell-symbol"
                              :class="[cells[r*gridSize + c].cssClasses]"
                              :style="[cells[r*gridSize + c].colorStyle, { fontSize: 'calc(50vmin / ' + gridSize + ')' }]">
                            {{ cells[r*gridSize + c].symbol }}
                        </span>
                    </div>
                </div>

                <div class="center-dot" v-if="showCenterDot"></div>
            </div>
        </main>

        <!-- Dialogs / Modals -->
        <div class="w3-modal"
             :class="[dialogShowed ? 'display-block' : 'display-none']"
             @click.self="hideDialog">
            <div class="w3-modal-content w3-animate-zoom" style="max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
                <header class="w3-container" style="background-color: var(--primary-color); color: white; padding: 16px; flex-shrink: 0;">
                    <span @click="hideDialog"
                          class="w3-button w3-display-topright w3-hover-none w3-hover-text-white"
                          style="font-size: 24px; padding: 8px 16px;">
                    &times;
                    </span>
                    <h2 style="margin: 0; font-size: 1.25rem;">ËÆæÁΩÆ‰∏éÁªüËÆ°</h2>
                </header>

                <div class="w3-bar w3-border-bottom" style="padding: 0 8px; flex-shrink: 0;">
                    <button class="tablink w3-bar-item w3-button"
                            @click="changeDialogTab('settings')"
                            :class="[settingsTabVisible  ? 'w3-border-bottom w3-border-blue' : '']"
                            style="color: var(--text-main);">
                        ËÆæÁΩÆ
                    </button>
                    <button class="tablink w3-bar-item w3-button"
                            @click="changeDialogTab('stats')"
                            :class="[statsTabVisible ? 'w3-border-bottom w3-border-blue' : '']"
                            style="color: var(--text-main);">
                        ÁªüËÆ°
                    </button>
                    <button class="tablink w3-bar-item w3-button"
                            @click="changeDialogTab('mousemap')"
                            :class="[mousemapTabVisible ? 'w3-border-bottom w3-border-blue' : '']"
                            style="color: var(--text-main);">
                        Èº†Ê†áËΩ®Ëøπ
                    </button>
                    <button class="tablink w3-bar-item w3-button"
                            @click="changeDialogTab('history')"
                            :class="[historyTabVisible ? 'w3-border-bottom w3-border-blue' : '']"
                            style="color: var(--text-main);">
                        ÂéÜÂè≤ËÆ∞ÂΩï
                    </button>
                </div>

                <div class="w3-container w3-padding-16" style="overflow-y: auto; flex: 1;">
                    
                    <!-- SETTINGS TAB -->
                    <div v-if="settingsTabVisible">
                        <div class="w3-row-padding" style="margin-bottom: 16px;">
                            <div class="w3-half">
                                <label for="grid_size" class="w3-block" style="margin-bottom: 8px;">ÁΩëÊ†ºÂ§ßÂ∞è</label>
                                <select id="grid_size" class="w3-select" style="width: 100%" v-model="gridSize">
                                    <option v-for="n in 9" :value="n+1">{{n+1}} x {{n+1}}</option>
                                </select>
                            </div>
                            <div class="w3-half">
                                <label for="groups" class="w3-block" style="margin-bottom: 8px;">ÂàÜÁªÑÊï∞Èáè</label>
                                <select id="groups" class="w3-select" style="width: 100%" v-model="groupCount">
                                    <option value="1">1 ÁªÑ</option>
                                    <option value="2">2 ÁªÑ</option>
                                    <option value="3">3 ÁªÑ</option>
                                    <option value="4">4 ÁªÑ</option>
                                </select>
                            </div>
                        </div>

                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <div style="margin-bottom: 8px;">
                                    <input class="w3-check" type="checkbox" v-model="inverseCount" :disabled="variousCounts" id="inv_count">
                                    <label for="inv_count">ÂÄíÂ∫èËÆ°Êï∞</label>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <input class="w3-check" type="checkbox" v-model="divergentCount" :disabled="variousCounts" id="div_count">
                                    <label for="div_count">ÂèëÊï£ËÆ°Êï∞</label>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <input class="w3-check" type="checkbox" v-model="variousCounts" id="var_count">
                                    <label for="var_count">Â§öÁßçËÆ°Êï∞</label>
                                </div>
                            </div>
                            <div class="w3-half">
                                <div class="w3-container w3-padding-0" style="margin-top: 0;">
                                    <div class="color-num" v-if="groupCount == 1" v-html="groupRange(0)"></div>
                                    <div class="color-num" :style="groupColorStyles[0]" v-if="groupCount > 1" v-html="groupRange(0)"></div>
                                    <div class="color-num" :style="groupColorStyles[1]" v-if="groupCount > 1" v-html="groupRange(1)"></div>
                                    <div class="color-num" :style="groupColorStyles[2]" v-if="groupCount > 2" v-html="groupRange(2)"></div>
                                    <div class="color-num" :style="groupColorStyles[3]" v-if="groupCount == 4" v-html="groupRange(3)"></div>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 16px 0; border-color: var(--border-color);">

                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <input class="w3-check" type="checkbox" v-model="timerMode" id="timer_mode">
                                <label for="timer_mode">ËÆ°Êó∂Âô®Ê®°Âºè</label>
                            </div>
                            <div class="w3-half" v-if="timerMode">
                                <label for="minutes" style="margin-right: 8px;">ÂàÜÈíü</label>
                                <select id="minutes" class="w3-select" style="width: auto; display: inline-block;" v-model="timerMinutes">
                                    <option v-for="t in [1,2,3,4,5,10,15,20,25,30]" :value="t">{{t}}</option>
                                </select>
                            </div>
                        </div>

                        <hr style="margin: 16px 0; border-color: var(--border-color);">

                        <div class="w3-row-padding">
                            <div class="w3-col" style="display: flex; flex-wrap: wrap; gap: 16px;">
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="showHover" id="show_hover">
                                    <label for="show_hover">ÊòæÁ§∫ÊÇ¨ÂÅú</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="showTrace" id="show_trace">
                                    <label for="show_trace">ÊòæÁ§∫ËΩ®Ëøπ</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="showClickResult" id="show_click">
                                    <label for="show_click">ÊòæÁ§∫ÁÇπÂáªÁªìÊûú</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="showCenterDot" id="show_center">
                                    <label for="show_center">ÊòæÁ§∫‰∏≠ÂøÉÁÇπ</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="shuffleSymbols" id="shuffle_symbols">
                                    <label for="shuffle_symbols">Ê¥óÁâåÂè∑Á†Å</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="turnSymbols" id="turn_symbols">
                                    <label for="turn_symbols">ËΩ¨ÂºØÁºñÂè∑</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="spinSymbols" id="spin_symbols">
                                    <label for="spin_symbols">Ëá™ÊóãÊï∞</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="show69Dot" id="show_69_dot">
                                    <label for="show_69_dot">Show 69 ÁÇπ</label>
                                </span>
                                <span>
                                    <input class="w3-check" type="checkbox" v-model="soundEnabled" id="sound_enabled">
                                    <label for="sound_enabled">Â£∞Èü≥ÂèçÈ¶à</label>
                                </span>
                            </div>
                        </div>

                        <div class="w3-center" style="margin-top: 24px; margin-bottom: 8px;">
                            <button class="w3-button w3-blue w3-round-large w3-large" @click="hideDialog" style="width: 100%;">
                                ÂºÄÂßãÊ∏∏Êàè
                            </button>
                        </div>
                    </div>

                    <!-- STATS TAB -->
                    <div v-if="statsTabVisible">
                        <div class="w3-row w3-center" style="margin-bottom: 20px;">
                            <div class="w3-col s4">
                                <div class="w3-large">Êó∂Èó¥</div>
                                <div class="w3-xlarge w3-text-blue">{{ stats.timeDiff() }}</div>
                            </div>
                            <div class="w3-col s4">
                                <div class="w3-large">Ê≠£Á°Æ</div>
                                <div class="w3-xlarge w3-text-green">{{ stats.correctClicks }}</div>
                            </div>
                            <div class="w3-col s4">
                                <div class="w3-large">ÈîôËØØ</div>
                                <div class="w3-xlarge w3-text-red">{{ stats.wrongClicks }}</div>
                            </div>
                        </div>

                        <table class="w3-table w3-bordered w3-striped w3-white">
                            <thead>
                                <tr class="w3-light-grey">
                                    <th>ÁªÑ</th>
                                    <th>Êï∞Â≠ó</th>
                                    <th>Êó∂Èó¥ (s)</th>
                                    <th>ÁªìÊûú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="click in stats.clicks">
                                    <td>{{ click.groupN + 1 }}</td>
                                    <td>{{ click.number }}</td>
                                    <td>{{ click.time }}</td>
                                    <td>
                                        <span v-if="!click.err" class="w3-text-green">‚úî</span>
                                        <span v-else class="w3-text-red">‚úò</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- MOUSEMAP TAB -->
                    <div v-if="mousemapTabVisible" class="w3-center">
                        <p>Èº†Ê†áÁßªÂä®Ë∑ØÂæÑ‰∏éÁÇπÂáª‰ΩçÁΩÆ</p>
                        <div class="w3-padding">
                            <canvas ref="mousemap_canvas" width="400" height="400" 
                                    class="mouse-map" 
                                    style="max-width: 100%; height: auto; background: white; border: 1px solid #ccc;">
                            </canvas>
                        </div>
                    </div>

                    <!-- HISTORY TAB -->
                    <div v-if="historyTabVisible">
                        <!-- Filters -->
                        <div class="w3-row-padding w3-margin-bottom">
                            <div class="w3-third">
                                <label>ÂºÄÂßãÊó•Êúü</label>
                                <input class="w3-input w3-border" type="date" v-model="historyFilter.startDate">
                            </div>
                            <div class="w3-third">
                                <label>ÁªìÊùüÊó•Êúü</label>
                                <input class="w3-input w3-border" type="date" v-model="historyFilter.endDate">
                            </div>
                            <div class="w3-third">
                                <label>ÁΩëÊ†ºÂ§ßÂ∞è</label>
                                <select class="w3-select w3-border" v-model="historyFilter.gridSize">
                                    <option value="all">ÂÖ®ÈÉ®</option>
                                    <option v-for="n in 9" :value="n+1">{{n+1}} x {{n+1}}</option>
                                </select>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="w3-bar w3-margin-bottom">
                            <button class="w3-button w3-blue w3-small" @click="exportHistory('csv')">ÂØºÂá∫ CSV</button>
                            <button class="w3-button w3-blue w3-small" @click="exportHistory('json')">ÂØºÂá∫ JSON</button>
                            <span class="w3-right w3-small w3-padding">ÂÖ± {{filteredHistory.length}} Êù°ËÆ∞ÂΩï</span>
                        </div>

                        <!-- Table -->
                        <div style="overflow-x: auto;">
                            <table class="w3-table w3-bordered w3-striped w3-white w3-small">
                                <thead>
                                    <tr class="w3-light-grey">
                                        <th @click="toggleHistorySort('date')" style="cursor: pointer">
                                            Êó•Êúü <span v-if="historySort.field==='date'">{{historySort.order==='asc'?'‚ñ≤':'‚ñº'}}</span>
                                        </th>
                                        <th @click="toggleHistorySort('gridSize')" style="cursor: pointer">
                                            ÁΩëÊ†º <span v-if="historySort.field==='gridSize'">{{historySort.order==='asc'?'‚ñ≤':'‚ñº'}}</span>
                                        </th>
                                        <th @click="toggleHistorySort('timeSeconds')" style="cursor: pointer">
                                            Áî®Êó∂ <span v-if="historySort.field==='timeSeconds'">{{historySort.order==='asc'?'‚ñ≤':'‚ñº'}}</span>
                                        </th>
                                        <th @click="toggleHistorySort('mistakes')" style="cursor: pointer">
                                            ÈîôËØØ <span v-if="historySort.field==='mistakes'">{{historySort.order==='asc'?'‚ñ≤':'‚ñº'}}</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="record in filteredHistory" :key="record.id">
                                        <td>{{ formatDate(record.date) }}</td>
                                        <td>{{ record.gridSize }} x {{ record.gridSize }}</td>
                                        <td>{{ record.time }}</td>
                                        <td>{{ record.mistakes }}</td>
                                    </tr>
                                    <tr v-if="filteredHistory.length === 0">
                                        <td colspan="4" class="w3-center">Êó†ËÆ∞ÂΩï</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="js/audio-controller.js"></script>
    <script src="js/schulte.js"></script>
</body>
</html>
